<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>River Slots â€” Halloween Spin & Win ðŸŽƒ</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e0b12; --card:#15121b; --ink:#f4f1ff; --muted:#cfc7ffcc;
  --accent:#ff7a00; --accent-2:#ffcc66; --line:rgba(255,255,255,0.12);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:Poppins,system-ui,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
.container{max-width:960px;margin:0 auto;padding:16px 16px 56px}
.header{text-align:center}
.header h1{margin:8px 0 4px;font-weight:800;font-size:clamp(26px,5.5vw,40px)}
.header .accent{color:var(--accent-2);text-shadow:0 0 18px rgba(255,165,66,.35)}
.subtitle{color:var(--muted);margin:0 0 8px}
.card{margin:12px auto;padding:16px;border:1px solid var(--line);border-radius:18px;background:
  radial-gradient(120% 120% at 50% -20%, rgba(255,153,0,.08), transparent 60%), var(--card)}
.form-row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.form-row label{min-width:110px;color:var(--muted)}
.form-row input{
  flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--line);
  background:#0d0a12;color:var(--ink);caret-color:var(--ink);
}
.form-row input::placeholder{color:#b8b0d6}
.form-row input:-webkit-autofill,
.form-row input:-webkit-autofill:hover,
.form-row input:-webkit-autofill:focus{
  -webkit-text-fill-color:var(--ink);
  transition:background-color 5000s ease-in-out 0s;
  box-shadow: 0 0 0px 1000px #0d0a12 inset !important;
}

.wheel-wrap{display:grid;place-items:center;gap:14px}
#wheel{width:100%;max-width:440px;aspect-ratio:1/1;background:transparent;display:block}

.btn{
  border:0;padding:14px 22px;border-radius:16px;background:linear-gradient(180deg,#ffb14d,#ff7a00);
  color:#1a0f00;font-weight:800;letter-spacing:.3px;cursor:pointer;box-shadow:0 8px 24px rgba(255,122,0,.25)
}
.btn:disabled{opacity:.55;cursor:not-allowed}
.status{text-align:center;color:var(--muted);min-height:22px}
.footer{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;color:var(--muted);margin-top:16px}
.footer a{color:#ffe08a;text-decoration:underline}

/* Modal (win + admin) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal.show{display:flex}
.modal-card{width:min(94vw,620px);border-radius:18px;padding:22px;text-align:center;background:#1b1424;border:1px solid var(--line)}
.modal-card h3{margin:0 0 8px;font-size:26px}
.modal-card .prize{font-size:22px;font-weight:800;color:#ffe08a;margin:6px 0 4px}
.table{width:100%;border-collapse:collapse;margin-top:10px;color:#f1e8ff}
.table th,.table td{padding:8px 10px;border-bottom:1px solid #2c2036;text-align:left;font-size:14px}
.tools{display:flex;gap:8px;justify-content:center;margin-top:12px}
.small{font-size:12px;color:#c9c0e1}
</style>
</head>
<body>
  <main class="container">
    <header class="header">
      <h1>River Slots <span class="accent">Halloween</span> Spin &amp; Win</h1>
      <p class="subtitle">One spin per day â€¢ Enter your name â€¢ Good luck! ðŸ‘»</p>
    </header>

    <section class="card">
      <div class="form-row">
        <label for="playerName">Your name</label>
        <input id="playerName" type="text" placeholder="Enter your name" maxlength="40" autocomplete="name" />
      </div>

      <div class="wheel-wrap">
        <canvas id="wheel" aria-label="Prize wheel" role="img"></canvas>
        <button id="spinBtn" class="btn">ðŸŽ¡ Spin</button>
      </div>

      <p id="status" class="status"></p>
    </section>

    <footer class="footer">
      <p>Â© <span id="year"></span> River Slots â€¢ Halloween Event</p>
      <a href="#" id="adminLogin">Admin</a>
      <span class="small">Results saved locally on this device. We can upgrade to Firebase/Netlify for global logs.</span>
    </footer>

    <!-- Netlify-compatible hidden form (safe on GitHub Pages) -->
    <form name="spin-log" hidden>
      <input type="text" name="player_name" />
      <input type="text" name="prize" />
      <input type="text" name="device_id" />
      <input type="text" name="timestamp_iso" />
      <input type="text" name="event_tag" value="RiverSlotsHalloween2025" />
    </form>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<script>
/*** Config ***/
const CFG = {
  eventTag: "RiverSlotsHalloween2025",
  spinLimit: "daily",
  adminPassword: "River2025!", // â† change if you want
  prizes: [
    { label: "50% Bonus", weight: 10 },
    { label: "40% Bonus", weight: 20 },
    { label: "$10 Freeplay", weight: 25 },
    { label: "Refer 5 Friends & Get $20 (CashApp)", weight: 20 },
    { label: "Extra $5 on the Game", weight: 20 },
    { label: "100% Bonus", weight: 5 }
  ]
};

/*** Elements ***/
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d', { alpha: true });
const spinBtn = document.getElementById('spinBtn');
const statusEl = document.getElementById('status');
const nameInput = document.getElementById('playerName');
document.getElementById('year').textContent = new Date().getFullYear();

/*** Responsive canvas â€” with safe minimum to prevent blank wheel ***/
function sizeCanvas(){
  const w = Math.floor(window.innerWidth - 32);
  const clamped = Math.min(440, Math.max(280, w)); // min 280px so it never collapses
  canvas.width = clamped;
  canvas.height = clamped;
}
sizeCanvas(); addEventListener('resize', sizeCanvas);

/*** Data & helpers ***/
const DEVKEY='rs_device_id', SPINKEY='rs_last_spin_ts', LOGKEY='rs_spin_log';
const deviceId = localStorage.getItem(DEVKEY) || (localStorage.setItem(DEVKEY, (crypto.randomUUID?.() || Date.now()+"-"+Math.random().toString(16).slice(2))), localStorage.getItem(DEVKEY));
const segs = CFG.prizes.map(p=>({label:p.label, weight:p.weight}));
const total = segs.reduce((a,b)=>a+b.weight,0);

function canSpin(){
  if(CFG.spinLimit!=='daily') return true;
  const last = +localStorage.getItem(SPINKEY)||0;
  if(!last) return true;
  const d=new Date(last), n=new Date();
  return !(d.getFullYear()==n.getFullYear()&&d.getMonth()==n.getMonth()&&d.getDate()==n.getDate());
}
function setNow(){ localStorage.setItem(SPINKEY, Date.now().toString()); }

function pickPrize(){
  const r=Math.random()*total; let a=0;
  for(const s of segs){ a+=s.weight; if(r<=a) return s; }
  return segs[segs.length-1];
}

/*** Text fitting ***/
function drawFittedText(text, maxWidth, maxLines, baseSize){
  let size = baseSize;
  ctx.font = `600 ${size}px Poppins`;
  while (ctx.measureText(text).width > maxWidth && size > 11){
    size -= 1;
    ctx.font = `600 ${size}px Poppins`;
  }
  const words = text.split(' ');
  const lines = [];
  let line = '';
  for (let i=0;i<words.length;i++){
    const test = (line ? line+' ' : '') + words[i];
    if (ctx.measureText(test).width > maxWidth && line) {
      lines.push(line);
      line = words[i];
    } else line = test;
  }
  if (line) lines.push(line);
  while (lines.length > maxLines){
    size -= 1;
    ctx.font = `600 ${size}px Poppins`;
    return drawFittedText(text, maxWidth, maxLines, size);
  }
  return {lines, size};
}

/*** Draw wheel (slices rotate; pointer stays fixed & BIG) ***/
function drawWheel(rot=0){
  const S=canvas.width, r=S/2;
  ctx.clearRect(0,0,S,S);

  // ROTATING SLICES
  ctx.save(); ctx.translate(r,r); ctx.rotate(rot);
  const colors=['#432053','#512565','#5e2b77','#6c3189','#7a39a0','#8741b6'];
  let a=-Math.PI/2;
  segs.forEach((s,i)=>{
    const ang=(s.weight/total)*Math.PI*2, b=a+ang;
    ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r*0.965,a,b); ctx.closePath();
    ctx.fillStyle=colors[i%colors.length]; ctx.fill();
    ctx.lineWidth=2; ctx.strokeStyle='rgba(255,255,255,.22)'; ctx.stroke();

    // Label
    ctx.save();
    const mid=(a+b)/2;
    const tx=Math.cos(mid)*r*0.62, ty=Math.sin(mid)*r*0.62;
    ctx.translate(tx,ty);
    ctx.rotate(mid + Math.PI/2);
    ctx.fillStyle='#fff4d6';
    const {lines,size}=drawFittedText(s.label, r*0.5, 3, 16);
    const lineH=size+2; let y=-((lines.length-1)*lineH)/2;
    ctx.textAlign='center';
    lines.forEach(L=>{ ctx.fillText(L,0,y); y+=lineH; });
    ctx.restore();

    a=b;
  });
  // Center hub
  ctx.beginPath(); ctx.arc(0,0,r*0.1,0,Math.PI*2);
  ctx.fillStyle='#ffb14d'; ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle='#5a3900'; ctx.stroke();
  ctx.restore();

  // FIXED POINTER (bigger)
  ctx.save();
  ctx.translate(r, r);
  const tipY = -r*0.965; // top rim
  ctx.beginPath();
  ctx.moveTo(-18, tipY + 30);
  ctx.lineTo( 18, tipY + 30);
  ctx.lineTo(  0, tipY - 8);
  ctx.closePath();
  ctx.fillStyle = '#ffcc66';
  ctx.fill();
  ctx.lineWidth=3.5; ctx.strokeStyle='#5a3900'; ctx.stroke();
  ctx.restore();
}
drawWheel(0);

/*** Compute angle for prize ***/
function angleFor(label){
  let a=-Math.PI/2;
  for(const s of segs){
    const ang=(s.weight/total)*Math.PI*2, b=a+ang;
    if(s.label===label) return (a+b)/2;
    a=b;
  }
  return -Math.PI/2;
}

/*** Spin animation ***/
function animateTo(target,onDone){
  const extra=5+Math.floor(Math.random()*3);
  const final=(Math.PI*2)*extra + (target - (-Math.PI/2));
  const duration=4600; const start=performance.now();
  (function frame(now){
    const t=Math.min(1,(now-start)/duration);
    const e=1-Math.pow(1-t,3);
    drawWheel(e*final);
    (t<1)?requestAnimationFrame(frame):onDone();
  })(start);
}

/*** Win modal + confetti ***/
function showWin(name, prize){
  confetti({ particleCount: 140, spread: 70, origin: { y: 0.3 } });
  confetti({ particleCount: 100, spread: 110, origin: { y: 0.3 } });
  let modal=document.querySelector('.modal.win');
  if(!modal){
    modal=document.createElement('div');
    modal.className='modal win';
    modal.innerHTML=`
      <div class="modal-card">
        <h3>ðŸŽ‰ Hurray, <span id="who"></span>!</h3>
        <div>You won:</div>
        <div class="prize" id="prizeText"></div>
        <button class="btn close">OK</button>
      </div>`;
    document.body.appendChild(modal);
    modal.querySelector('.close').addEventListener('click',()=>modal.classList.remove('show'));
  }
  modal.querySelector('#who').textContent = name || 'Player';
  modal.querySelector('#prizeText').textContent = prize;
  modal.classList.add('show');
}

/*** Local logging (device private) + optional Netlify forms POST ***/
function saveLog(row){
  const list = JSON.parse(localStorage.getItem(LOGKEY) || "[]");
  list.unshift(row);
  localStorage.setItem(LOGKEY, JSON.stringify(list.slice(0,500)));
}
function logSpin({playerName, prize}){
  const row = { name: playerName, prize, ts: new Date().toISOString() };
  saveLog(row);
  // Optional POST (works if deployed to Netlify later)
  try{
    const data={"form-name":"spin-log",player_name:playerName,prize,device_id:deviceId,timestamp_iso:row.ts,event_tag:CFG.eventTag};
    const body=new URLSearchParams(data).toString();
    fetch("/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body}).catch(()=>{});
  }catch(e){}
}

/*** Admin (local) ***/
document.getElementById('adminLogin').addEventListener('click', (e)=>{
  e.preventDefault();
  const pw = prompt("Admin password:");
  if(pw !== CFG.adminPassword) { alert("Incorrect password."); return; }
  showAdmin();
});

function showAdmin(){
  let modal=document.querySelector('.modal.admin');
  if(!modal){
    modal=document.createElement('div');
    modal.className='modal admin';
    modal.innerHTML=`
      <div class="modal-card" style="text-align:left">
        <h3 style="text-align:center">Admin â€” Results (this device)</h3>
        <table class="table">
          <thead><tr><th>Name</th><th>Prize</th><th>Time</th></tr></thead>
          <tbody id="logRows"></tbody>
        </table>
        <div class="tools">
          <button class="btn" id="exportCsv">Export CSV</button>
          <button class="btn" id="clearLog">Clear Log</button>
          <button class="btn close">Close</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
    modal.querySelector('.close').addEventListener('click',()=>modal.classList.remove('show'));
    modal.querySelector('#clearLog').addEventListener('click',()=>{
      if(confirm("Clear local results on this device?")){ localStorage.removeItem(LOGKEY); renderLog(); }
    });
    modal.querySelector('#exportCsv').addEventListener('click', exportCsv);
  }
  renderLog();
  modal.classList.add('show');
}

function renderLog(){
  const list = JSON.parse(localStorage.getItem(LOGKEY) || "[]");
  const tbody = document.getElementById('logRows');
  tbody.innerHTML = list.map(r=>`<tr><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.prize)}</td><td>${new Date(r.ts).toLocaleString()}</td></tr>`).join('') || `<tr><td colspan="3">No spins yet on this device.</td></tr>`;
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));}
function exportCsv(){
  const list = JSON.parse(localStorage.getItem(LOGKEY) || "[]");
  const rows = [["Name","Prize","Timestamp (ISO)"], ...list.map(r=>[r.name,r.prize,r.ts])];
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "river-slots-results.csv"; a.click();
  URL.revokeObjectURL(url);
}

/*** Spin ***/
spinBtn.addEventListener('click', ()=>{
  const playerName=(nameInput.value||"").trim();
  if(!playerName){ statusEl.textContent="Please enter your name."; nameInput.focus(); return; }
  if(!canSpin()){ statusEl.textContent="You've already had your spin today. Try again tomorrow!"; return; }

  spinBtn.disabled=true; statusEl.textContent="Spinningâ€¦";
  const prize = pickPrize();
  const target = angleFor(prize.label);

  animateTo(target, ()=>{
    setNow();
    statusEl.textContent="";
    showWin(playerName, prize.label);
    logSpin({playerName, prize:prize.label});
    spinBtn.disabled=false;
  });
});
</script>
</body>
</html>
